<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShuttleWinners by Rana</title>
<style>
/* ================== CSS ================== */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1a1a1a 0%,#4a0000 100%);min-height:100vh;position:relative;overflow-x:hidden;}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(196,30,58,0.03) 2px,rgba(196,30,58,0.03) 4px),repeating-linear-gradient(90deg,transparent,transparent 2px,rgba(196,30,58,0.03) 2px,rgba(196,30,58,0.03) 4px);background-size:50px 50px;z-index:0;pointer-events:none;}
.bg-shuttlecocks{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;overflow:hidden;}
.badminton-player{position:absolute;bottom:5%;right:3%;width:250px;height:350px;opacity:0.12;animation:playBadminton 1.5s infinite ease-in-out;}
@keyframes playBadminton{0%{transform:translateY(0) scaleY(1);}25%{transform:translateY(-30px) scaleY(0.95);}50%{transform:translateY(-15px) scaleY(1);}75%{transform:translateY(-25px) scaleY(0.98);}100%{transform:translateY(0) scaleY(1);}}
.badminton-player svg{width:100%;height:100%;filter:drop-shadow(0 0 10px rgba(196,30,58,0.3));}
.container{display:flex;min-height:100vh;position:relative;z-index:1;}
.menu-toggle{display:none;position:fixed;top:15px;left:15px;z-index:1001;background:linear-gradient(135deg,#c41e3a 0%,#8b0000 100%);color:white;border:none;padding:12px 15px;border-radius:8px;cursor:pointer;font-size:20px;box-shadow:0 4px 15px rgba(196,30,58,0.4);}
.sidebar{width:250px;background:rgba(20,20,20,0.95);backdrop-filter:blur(10px);box-shadow:2px 0 20px rgba(196,30,58,0.3);padding:20px;transition:transform 0.3s ease;border-right:2px solid #c41e3a;position:relative;z-index:1;}
.logo{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #c41e3a;display:flex;flex-direction:column;align-items:center;gap:8px;}
.logo-icon{font-size:48px;margin-bottom:8px;animation:float 3s ease-in-out infinite;display:inline-block;}
@keyframes float{0%,100%{transform:translateY(0px);}50%{transform:translateY(-8px);}}
.logo h1{color:#c41e3a;font-size:26px;margin:0;font-weight:700;letter-spacing:1px;text-shadow:0 0 15px rgba(196,30,58,0.6),0 2px 4px rgba(0,0,0,0.3);}
.logo .copyright{color:#999;font-size:11px;font-style:italic;margin-top:2px;opacity:0.8;letter-spacing:0.5px;}
.menu-item{padding:15px 20px;margin:10px 0;border-radius:10px;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:10px;color:#ddd;border:1px solid transparent;}
.menu-item:hover{background:linear-gradient(135deg,#c41e3a 0%,#8b0000 100%);color:white;transform:translateX(5px);border-color:#c41e3a;box-shadow:0 4px 15px rgba(196,30,58,0.3);}
    <div class="menu-item admin-only" onclick="goToSection('manage-teams')">üë• Manage Teams</div>
    <div class="menu-item admin-only" onclick="goToSection('manage-fixtures')">üìÖ Manage Fixtures</div>
    <div class="menu-item admin-only" onclick="doLogout()">üö™ Logout</div>
  </div>
  <div class="main-content">
    <div class="content-section active" id="fixture">
      <div class="card">
        <h2>Tournament Fixtures</h2>
        <div class="tabs-container">
          <div class="tab active" onclick="switchDay(1)">Day 1</div>
          <div class="tab" onclick="switchDay(2)">Day 2</div>
          <div class="tab" onclick="switchDay(3)">Day 3</div>
          <div class="tab" onclick="switchDay(4)">Final</div>
        </div>
        <div class="tab-content active" id="day-1">
          <table class="fixture-table">
            <thead><tr><th>Match</th><th>Team 1</th><th></th><th>Team 2</th><th>Score</th></tr></thead>
            <tbody id="day1Body"></tbody>
          </table>
        </div>
        <div class="tab-content" id="day-2">
          <table class="fixture-table">
            <thead><tr><th>Match</th><th>Team 1</th><th></th><th>Team 2</th><th>Score</th></tr></thead>
            <tbody id="day2Body"></tbody>
          </table>
        </div>
        <div class="tab-content" id="day-3">
          <table class="fixture-table">
            <thead><tr><th>Match</th><th>Team 1</th><th></th><th>Team 2</th><th>Score</th></tr></thead>
            <tbody id="day3Body"></tbody>
          </table>
        </div>
        <div class="tab-content" id="day-4">
          <div id="winnerAnnouncement" style="display:none;margin-bottom:30px;">
            <div class="card" style="background:linear-gradient(135deg,rgba(196,30,58,0.3) 0%,rgba(139,0,0,0.3) 100%);border:3px solid #c41e3a;text-align:center;padding:40px;">
              <div style="font-size:60px;margin-bottom:20px;animation:bounce 1s ease infinite;">üèÜ</div>
              <h2 style="color:#c41e3a;font-size:36px;margin-bottom:15px;text-shadow:0 0 20px rgba(196,30,58,0.8);">Winner Winner Chicken Dinner!</h2>
              <div id="winnerTeamDisplay" style="color:#fff;font-size:48px;font-weight:700;margin-bottom:20px;text-shadow:0 0 15px rgba(255,255,255,0.5);background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:pulse 2s ease infinite;"></div>
              <div style="font-size:40px;margin-top:20px;animation:celebrate 1.5s ease infinite;">üéâ üéä üéâ</div>
            </div>
          </div>
          <table class="fixture-table">
            <thead><tr><th>Match</th><th>Team 1</th><th></th><th>Team 2</th><th>Score</th></tr></thead>
            <tbody id="day4Body"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="content-section" id="ranking">
      <div class="card">
        <h2>Team Rankings</h2>
        <table class="ranking-table">
          <thead><tr><th>Rank</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>PD</th><th>Pts</th></tr></thead>
          <tbody id="rankingBody"></tbody>
        </table>
      </div>
    </div>
    <div class="content-section" id="rules">
      <div class="card">      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" required>
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%">Login</button>
      <button type="button" class="btn" style="width:100%;margin-top:10px;background:#333;color:#ddd" onclick="closeLogin()">Cancel</button>
    </form>
  </div>
</div>
<script type="module">
// ================== Supabase Configuration ==================
const SUPABASE_URL = 'https://ygyynxtuqgagcygqdmpu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlneXlueHR1cWdhZ2N5Z3FkbXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMDQyMzAsImV4cCI6MjA4MjU4MDIzMH0.epkP1_RVfLMCAFG33aekLmO0wrEDZQEBRyREXiKs1Os';
  const s1Input = document.getElementById('s1_' + matchId);
  const s2Input = document.getElementById('s2_' + matchId);

  if(!s1Input || !s2Input){
    notify('Score inputs not found', 'error');
    console.error('Inputs not found for matchId:', matchId);
    return;
  }

  const s1 = parseInt(s1Input.value) || 0;
  const s2 = parseInt(s2Input.value) || 0;

  console.log('Updating score for match:', matchId, 'Score:', s1, '-', s2);

  const { data, error } = await supabase
    .from('matches')
    .update({ s1, s2 })
    .eq('id', matchId)
    .select();

  if(error){
    notify('Error updating score: ' + error.message, 'error');
    console.error('Update error:', error);
    return;
  }

  console.log('Score updated successfully:', data);

  // Check if this is a final match that was just completed
  if(data && data.length > 0){
    const match = data[0];
    if(match.type === 'final' && match.s1 !== null && match.s2 !== null &&
       match.t1 !== 'Top 1 team' && match.t2 !== 'Top 2 team'){
      // Determine winner
      let winnerName = '';
      if(match.s1 > match.s2){
        winnerName = match.t1;
      } else if(match.s2 > match.s1){
        winnerName = match.t2;
      }
    
      if(winnerName){
        // Show winner panel
        showWinnerPanel(winnerName);
        notify('Final match completed! üèÜ');
      }
    }
  }

  notify('Score updated - Ranking will update automatically!');
   if(existing){
    notify('This match already exists!', 'error');
    return;
  }

  const { data, error } = await supabase
    .from('matches')
    .insert([{ day, num, t1, t2, type, s1: null, s2: null }])
    .select();

  if(error){
    notify('Error adding match: ' + error.message, 'error');
    console.error('Add match error:', error);
    return;
  }

  notify('Match added successfully!', 'success');

  // Clear form
  document.getElementById('newMatchNum').value = '';
  document.getElementById('newMatchT1').value = '';
  document.getElementById('newMatchT2').value = '';

  // Reload matches list and fixtures
  await loadMatchesList();
  await loadFixtures();
  await loadMatches();
}

window.deleteMatch = async function(matchId){
  if(!isAdmin) {
    notify('Not authorized', 'error');
    return;
  }

  if(!confirm('Are you sure you want to delete this match? This will also remove its score from rankings.')){
    return;
  }

  const { error } = await supabase
    .from('matches')
    .delete()
    .eq('id', matchId);

  if(error){
    notify('Error deleting match: ' + error.message, 'error');
    console.error('Delete match error:', error);
    return;
  }

  notify('Match deleted successfully!', 'success');

  // Recalculate rankings
  await calculateAndUpdateRankings();
  await displayRankings();

  // Reload everything
  await loadMatchesList();
  await loadFixtures();
  await loadMatches();
}

// ================== Initialize App ==================
window.addEventListener('load', async () => {
  await loadTeamsMap();

  // Set up real-time listener for matches (to recalculate rankings)
  try {
    supabase
      .channel('matches-changes')
      .on('postgres_changes',
        { event: 'UPDATE', schema: 'public', table: 'matches' },
        (payload) => {
          console.log('Match updated, recalculating rankings:', payload);
          calculateAndUpdateRankings();
        }
      )
      .subscribe((status) => {
        console.log('Matches subscription status:', status);
        // If realtime doesn't work, we'll recalculate on manual refresh
      });
  } catch(error) {
    console.log('Realtime for matches not available:', error);
  }

  // Load rankings and calculate if needed
  await loadRankings();

  // Always calculate rankings on load to ensure they're up to date
  await calculateAndUpdateRankings();

  goToSection('fixture');
});
</script>
</body>
</html> 
